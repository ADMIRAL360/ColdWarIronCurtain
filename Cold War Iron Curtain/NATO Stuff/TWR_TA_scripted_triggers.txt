in_war_with_ta = {
	is_in_faction_with = USA
	OR = {
		has_war_with = event_target:ta_defeated_by
		AND = {
			is_subject = yes
			overlord = {
				has_war_with = event_target:ta_defeated_by
			}
		}
	}
}

TOR_total_votes = {

	clear_temp_array = temp_voting_for_array
	clear_temp_array = temp_voting_against_array
	clear_temp_array = temp_voting_neutral_array

	all_of_scopes = {
		array = TOR.TOR_member_countries

		if = {
			limit = {
				check_variable = { TOR_vote_value = 1 }
			}
			add_to_temp_array = { temp_voting_for_array = THIS } 
		}
		else_if = {
			limit = {
				check_variable = { TOR_vote_value = -1 }
			}
			add_to_temp_array = { temp_voting_against_array = THIS }
		}
		else_if  = {
			limit = {
				AND = {
					has_variable = TOR_vote_value
					check_variable = { TOR_vote_value = 0 }
				}
			}
			add_to_temp_array = { temp_voting_neutral_array = THIS }
		}
		
	}

	set_temp_variable = { TOR_votes_neutral = temp_voting_neutral_array^num }
	set_temp_variable = { TOR_votes_negative = temp_voting_against_array^num }
	set_temp_variable = { TOR_votes_positive = temp_voting_for_array^num }

	set_temp_variable = { TOR_votes_majority_needed = TOR.TOR_member_countries^num }
	divide_temp_variable = { TOR_votes_majority_needed = 2 }
	round_temp_variable = TOR_votes_majority_needed
	#add_to_temp_variable = { TOR_votes_majority_needed = 1 }
}

TOR_whip_positive_allowed = {
	custom_trigger_tooltip = {
		tooltip = TOR_whip_has_voted_tt
		has_variable = TOR_whippee:TOR_vote_value
	}
	NOT = { 
		custom_trigger_tooltip = {
			tooltip = TOR_whip_positive_vote_tt
			check_variable = { TOR_whippee:TOR_vote_value = 1 }
		}
	}
	custom_trigger_tooltip = {
		tooltip = TOR_whip_accepting_whipping
		check_variable = { TOR_whippee:TOR_vote_intention > -20 }
	}


	custom_trigger_tooltip = {
		tooltip = TOR_has_been_whipped_recently
		var:TOR_whippee = { NOT = { has_country_flag = TOR_has_been_whipped_recently } }
	}
	
	hidden_trigger = { 
		TOR_calculate_positive_whip_cost = yes
	}
	hidden_trigger = {
		ROOT = {
			has_political_power > TOR_whip_cost
		}
	}
}

TOR_whip_negative_allowed = {
	custom_trigger_tooltip = {
		tooltip = TOR_whip_has_voted_tt
		has_variable = TOR_whippee:TOR_vote_value
	}
	NOT = { 
		custom_trigger_tooltip = {
			tooltip = TOR_whip_negative_vote_tt
			check_variable = { TOR_whippee:TOR_vote_value = -1 }
		}
	}

	custom_trigger_tooltip = {
		tooltip = TOR_whip_accepting_whipping
		check_variable = { TOR_whippee:TOR_vote_intention < 20 }
	}
	 

	custom_trigger_tooltip = {
		tooltip = TOR_has_been_whipped_recently
		var:TOR_whippee = { NOT = { has_country_flag = TOR_has_been_whipped_recently } }
	}
	hidden_trigger = { 
		TOR_calculate_negative_whip_cost = yes
	}
	hidden_trigger = {
		ROOT = {
			has_political_power > TOR_whip_cost
		}
	}
}

TOR_calculate_positive_whip_cost = {

	TOR_calculate_whip_cost = yes 

	if = { #if voting intention is negative 
		limit = {
			check_variable = { TOR_vote_intention < 0 }
		}

		set_temp_variable = { TOR_vote_intention_effect_display = TOR_vote_intention }

		multiply_temp_variable = { TOR_vote_intention_effect_display = -1 }
		divide_temp_variable = { TOR_vote_intention_effect_display = 5 }
		set_temp_variable = { TOR_vote_intention_effect = TOR_vote_intention_effect_display }
		add_to_temp_variable = { TOR_vote_intention_effect = 1 }
		multiply_temp_variable = { TOR_whip_cost = TOR_vote_intention_effect }
	}

	else = {
		set_temp_variable = { TOR_vote_intention_effect_display = 0 }
	}
}

TOR_calculate_negative_whip_cost = {

	TOR_calculate_whip_cost = yes 

	if = { #if voting intention is negative 
		limit = {
			check_variable = { TOR_vote_intention > 0 }
		}

		set_temp_variable = { TOR_vote_intention_effect_display = TOR_vote_intention }

		divide_temp_variable = { TOR_vote_intention_effect_display = 5 }
		set_temp_variable = { TOR_vote_intention_effect = TOR_vote_intention_effect_display }
		add_to_temp_variable = { TOR_vote_intention_effect = 1 }
		multiply_temp_variable = { TOR_whip_cost = TOR_vote_intention_effect }
	}

	else = {
		set_temp_variable = { TOR_vote_intention_effect_display = 0 }
	}
}


TOR_calculate_whip_cost = {

	set_temp_variable = { TOR_total_factories = 0 }

	TOR = {
		all_of_scopes = {
			array = TOR_member_countries

			add_to_temp_variable = { TOR_total_factories = num_of_factories }
		}
	}

	set_temp_variable = { TOR_faction_leader_bonus = 0.2 }
	set_temp_variable = { TOR_major_bonus = 0.175 }
	set_temp_variable = { TOR_major_flag_bonus = 0.15 }

	multiply_temp_variable = { TOR_faction_leader_bonus = TOR_total_factories }
	multiply_temp_variable = { TOR_major_bonus = TOR_total_factories }
	multiply_temp_variable = { TOR_major_flag_bonus = TOR_total_factories }
 
	var:TOR_whippee = {
		set_temp_variable = { TOR_this_absolute_power = num_of_factories }

		if = {
			limit = {
				is_faction_leader = yes 
			}

			add_to_temp_variable = { TOR_this_absolute_power = TOR_faction_leader_bonus }
		}
		else_if = {
			limit = {
				is_major = yes 
			}

			add_to_temp_variable = { TOR_this_absolute_power = TOR_major_bonus }
		}
		else_if = {
			limit = {
				has_country_flag = TOR_major_member
			}

			add_to_temp_variable = { TOR_this_absolute_power = TOR_major_flag_bonus }
		}
	}

	var:TOR_whipper = {

		set_temp_variable = { TOR_whipper_absolute_power = num_of_factories }
		if = {
			limit = {
				is_faction_leader = yes 
			}
	
			add_to_temp_variable = { TOR_whipper_absolute_power = TOR_faction_leader_bonus }
		}
		else_if = {
			limit = {
				is_major = yes 
			}
	
			add_to_temp_variable = { TOR_whipper_absolute_power = TOR_major_bonus }
		}
		else_if = {
			limit = {
				has_country_flag = TOR_major_member
			}
	
			add_to_temp_variable = { TOR_whipper_absolute_power = TOR_major_flag_bonus }
		}
	}

	set_temp_variable = { TOR_this_relative_power = TOR_this_absolute_power }
	multiply_temp_variable = { TOR_this_relative_power = 10 }
	divide_temp_variable = { TOR_this_relative_power = TOR_total_factories }

	clamp_temp_variable = {
		var = TOR_this_relative_power
		min = 1
		max = 10 
	}

	set_temp_variable = { TOR_whipper_relative_power = TOR_whipper_absolute_power }
	multiply_temp_variable = { TOR_whipper_relative_power = 10 }
	divide_temp_variable = { TOR_whipper_relative_power = TOR_total_factories }

	clamp_temp_variable = {
		var = TOR_whipper_relative_power
		min = 1
		max = 10 
	}

	set_temp_variable = { TOR_whip_coefficient = TOR_this_relative_power }
	divide_temp_variable = { TOR_whip_coefficient = TOR_whipper_relative_power }

	set_temp_variable = { TOR_whip_cost = 25 }
	multiply_temp_variable = { TOR_whip_cost = TOR_whip_coefficient }

	set_temp_variable = { TOR_whip_coefficient_display = TOR_whip_coefficient }
	subtract_from_temp_variable = { TOR_whip_coefficient_display = 1 }

	clamp_temp_variable = {
		var = TOR_whip_cost
		min = 5
		max = 100
	}
}